<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="Using The Library" />
<meta name="DC.relation" scheme="URI" content="GUID-066D09D2-5550-49D9-ADA2-60A702DB243E.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="using-the-library" />
<link rel="stylesheet" type="text/css" href="stylesheets/commonltr.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<link rel="stylesheet" type="text/css" href="./stylesheets/common-extended.css" /><title>Using The Library</title>
<meta name="Microsoft.Help.Id" content="GUID-EDFB1AB8-CD6B-446F-8E25-F2167287A1AF-using-the-library" />
<meta name="Microsoft.Help.TocParent" content="GUID-EDFB1AB8-CD6B-446F-8E25-F2167287A1AF" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLABÂ® Harmony Core Library Reference A 11/2021" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
        function cpy(id, button) {
        
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                    button.textContent = "Copy";
                    button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
              console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
        }
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-51740620-007C-449D-A985-84207C03F2DF"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style></head>
<body id="using-the-library">
<h1 class="title topictitle1" id="ariaid-title1">Using The Library</h1><div class="body"><p class="p">The File System Service (SYS_FS) provides an application programming interface (API) through which a utility or user program requests services of a file system. Refer to the Library Interface section or the generated <strong class="ph b">sys_fs.h</strong> file for all the supported API's.</p>
<p class="p"><strong class="ph b">Application Flow</strong></p>
<ul class="ul"><li class="li with-image"><p class="p">The application must first mount the media drive for the FS Framework to access the media. Unless the mounting process returns successfully, the application should continue trying to mount the drive. If the drive is not attached, the mounting process will fail. In such a situation, the application should not proceed further unless the mounting is success.</p>
<ul class="ul"><li class="li"><p class="p"><strong class="ph b">Mounting a Formatted Drive</strong></p>
</li>
</ul>
<br /><img class="image" src="GUID-F9F41A4B-674F-4BBB-9DE5-B188DF909416-low.png" alt="sys_fs_mount_formatted" /><br /><ul class="ul"><li class="li"><p class="p"><strong class="ph b">Mounting a Un-Formatted Drive</strong></p>
<ul class="ul"><li class="li"><p class="p">If the Drive to be mounted is Un-formatted (No File system) then the application needs to format the drive using <strong class="ph b">SYS_FS_DriveFormat()</strong> once the <strong class="ph b">SYS_FS_Mount()</strong> returns success. The application can make use of <strong class="ph b">SYS_FS_Error()</strong> API to check if the mount was successful with no file system on the drive.</p>
</li>
</ul>
</li>
</ul>
<br /><img class="image" src="GUID-CDDA2030-E224-4B63-8DDF-349ACC6A0DD5-low.png" alt="sys_fs_mount_unformatted" /><br /></li>
<li class="li"><p class="p">Once the drive is mounted, the application code can then open the file from the drive with different attributes (such as read/write/append).</p>
<ul class="ul"><li class="li"><p class="p">If the file open returns a valid handle, the application can proceed further. Otherwise, the application can keep trying to open the file.</p>
</li>
<li class="li"><p class="p">The reason for an invalid handle could be that the application was trying to open a file in read mode from the drive that does not exist. Another reason for an invalid handle is when the application tries to open a file in write mode but the drive is write-protected.</p>
</li>
</ul>
</li>
<li class="li"><p class="p">Once the file is opened, the valid file handle is further used to read/write data to the file. Once the required operation is performed on the file, the file can then be closed by the application by passing the file handle.</p>
</li>
</ul>
<br /><img class="image" src="GUID-F837075F-09BB-4A26-A069-51E28F974DE6-low.png" alt="sys_fs_open_read_write_close" /><br /><p class="p"><strong class="ph b">Example Application to create and write to a file on SD Card</strong></p>
<pre class="pre codeblock language-c"><button title="Copy Code" class="copy-code" onclick="cpy('d217056e70', this);">Copy</button><code id="d217056e70" content="SYS_FS_HANDLE fileHandle;&#xA;&#xA;APP_STATES state;&#xA;&#xA;void APP_Initialize ( void )&#xA;{&#xA;    /* Initialize the app state to wait for media attach. */&#xA;    state = APP_MOUNT_DISK;&#xA;}&#xA;&#xA;void App_Task(void)&#xA;{&#xA;    switch(state)&#xA;    {&#xA;        case APP_MOUNT_DISK:&#xA;        {&#xA;            if (SYS_FS_Mount (&#34;/dev/mmcblka1&#34;, &#34;/mnt/mydrive&#34;, FAT, 0, NULL) == SYS_FS_RES_SUCCESS)&#xA;            {&#xA;                state = APP_FILE_OPEN;&#xA;            }&#xA;&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_FILE_OPEN:&#xA;        {&#xA;            /* Will open a file in write mode. It creates the file if it does not exist */&#xA;            fileHandle = SYS_FS_FileOpen(&#34;/mnt/mydrive/file.txt&#34;, SYS_FS_FILE_OPEN_WRITE);&#xA;&#xA;            if (fileHandle != SYS_FS_HANDLE_INVALID)&#xA;            {&#xA;                state = APP_FILE_WRITE;&#xA;            }&#xA;&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_FILE_WRITE:&#xA;        {&#xA;            if (SYS_FS_FileWrite(fileHandle, &#34;HELLO WORLD&#34;, sizeof(&#34;HELLO WORLD&#34;)) == -1)&#xA;            {&#xA;                /* Write Failed Error Out */&#xA;                state = APP_FILE_ERROR;&#xA;            }&#xA;            else&#xA;            {&#xA;                state = APP_FILE_CLOSE;&#xA;            }&#xA;&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_FILE_CLOSE:&#xA;        {&#xA;            SYS_FS_FileClose(fileHandle);&#xA;&#xA;            state = APP_FILE_UNMOUNT;&#xA;&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_FILE_UNMOUNT:&#xA;        {&#xA;             SYS_FS_UnMount(&#34;/mnt/mydrive&#34;);&#xA;&#xA;             state = APP_IDLE;&#xA;&#xA;             break&#xA;        }&#xA;&#xA;        case APP_IDLE:&#xA;        {&#xA;            break;&#xA;        }&#xA;&#xA;        case APP_ERROR:&#xA;        {&#xA;            /* The application comes here when the demo has failed. Close the opened file */&#xA;            SYS_FS_FileClose (fileHandle);&#xA;&#xA;            break;&#xA;        }&#xA;&#xA;        default:&#xA;        {&#xA;            break;&#xA;        }&#xA;    }&#xA;}&#xA;">SYS_FS_HANDLE fileHandle<span class="ph token punctuation">;</span>

APP_STATES state<span class="ph token punctuation">;</span>

<span class="ph token keyword">void</span> APP_Initialize <span class="ph token punctuation">(</span> <span class="ph token keyword">void</span> <span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token comment">/* Initialize the app state to wait for media attach. */</span>
    state <span class="ph token operator">=</span> APP_MOUNT_DISK<span class="ph token punctuation">;</span>
<span class="ph token punctuation">}</span>

<span class="ph token keyword">void</span> <span class="ph token function">App_Task</span><span class="ph token punctuation">(</span><span class="ph token keyword">void</span><span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token keyword">switch</span><span class="ph token punctuation">(</span>state<span class="ph token punctuation">)</span>
    <span class="ph token punctuation">{</span>
        <span class="ph token keyword">case</span> APP_MOUNT_DISK<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span>SYS_FS_Mount <span class="ph token punctuation">(</span><span class="ph token string">"/dev/mmcblka1"</span><span class="ph token punctuation">,</span> <span class="ph token string">"/mnt/mydrive"</span><span class="ph token punctuation">,</span> FAT<span class="ph token punctuation">,</span> <span class="ph token number">0</span><span class="ph token punctuation">,</span> <span class="ph token constant">NULL</span><span class="ph token punctuation">)</span> <span class="ph token operator">==</span> SYS_FS_RES_SUCCESS<span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                state <span class="ph token operator">=</span> APP_FILE_OPEN<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>

            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_FILE_OPEN<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* Will open a file in write mode. It creates the file if it does not exist */</span>
            fileHandle <span class="ph token operator">=</span> <span class="ph token function">SYS_FS_FileOpen</span><span class="ph token punctuation">(</span><span class="ph token string">"/mnt/mydrive/file.txt"</span><span class="ph token punctuation">,</span> SYS_FS_FILE_OPEN_WRITE<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span>fileHandle <span class="ph token operator">!=</span> SYS_FS_HANDLE_INVALID<span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                state <span class="ph token operator">=</span> APP_FILE_WRITE<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>

            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_FILE_WRITE<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token keyword">if</span> <span class="ph token punctuation">(</span><span class="ph token function">SYS_FS_FileWrite</span><span class="ph token punctuation">(</span>fileHandle<span class="ph token punctuation">,</span> <span class="ph token string">"HELLO WORLD"</span><span class="ph token punctuation">,</span> <span class="ph token keyword">sizeof</span><span class="ph token punctuation">(</span><span class="ph token string">"HELLO WORLD"</span><span class="ph token punctuation">)</span><span class="ph token punctuation">)</span> <span class="ph token operator">==</span> <span class="ph token operator">-</span><span class="ph token number">1</span><span class="ph token punctuation">)</span>
            <span class="ph token punctuation">{</span>
                <span class="ph token comment">/* Write Failed Error Out */</span>
                state <span class="ph token operator">=</span> APP_FILE_ERROR<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>
            <span class="ph token keyword">else</span>
            <span class="ph token punctuation">{</span>
                state <span class="ph token operator">=</span> APP_FILE_CLOSE<span class="ph token punctuation">;</span>
            <span class="ph token punctuation">}</span>

            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_FILE_CLOSE<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token function">SYS_FS_FileClose</span><span class="ph token punctuation">(</span>fileHandle<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

            state <span class="ph token operator">=</span> APP_FILE_UNMOUNT<span class="ph token punctuation">;</span>

            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_FILE_UNMOUNT<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
             <span class="ph token function">SYS_FS_UnMount</span><span class="ph token punctuation">(</span><span class="ph token string">"/mnt/mydrive"</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

             state <span class="ph token operator">=</span> APP_IDLE<span class="ph token punctuation">;</span>

             <span class="ph token keyword">break</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_IDLE<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">case</span> APP_ERROR<span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token comment">/* The application comes here when the demo has failed. Close the opened file */</span>
            SYS_FS_FileClose <span class="ph token punctuation">(</span>fileHandle<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>

        <span class="ph token keyword">default</span><span class="ph token operator">:</span>
        <span class="ph token punctuation">{</span>
            <span class="ph token keyword">break</span><span class="ph token punctuation">;</span>
        <span class="ph token punctuation">}</span>
    <span class="ph token punctuation">}</span>
<span class="ph token punctuation">}</span>
</code></pre></div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-066D09D2-5550-49D9-ADA2-60A702DB243E.html">File System Service</a></div>
</div>
</div></body>
</html>